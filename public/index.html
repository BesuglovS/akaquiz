<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>–ê–∫–∞–ö–≤–∏–∑</title>
    <link rel="stylesheet" href="style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap"
      rel="stylesheet"
    />
    <style>
      .theme-toggle {
        position: fixed;
        top: 15px;
        right: 15px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        cursor: pointer;
        font-size: 1.3rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
      }
      .theme-toggle:hover {
        background: rgba(255, 255, 255, 0.4);
        transform: scale(1.1);
      }
    </style>
  </head>
  <body class="player-body">
    <button class="theme-toggle" id="themeToggle" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
      üåô
    </button>
    <div class="player-container">
      <div id="login" class="card auth-card">
        <h1>–ê–∫–∞–ö–≤–∏–∑</h1>
        <p>–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π –Ω–∏–∫–Ω–µ–π–º, —á—Ç–æ–±—ã –≤–æ–π—Ç–∏ –≤ –∏–≥—Ä—É</p>
        <div class="input-group">
          <input
            type="text"
            id="nick-input"
            placeholder="–í–∞—à –∫—Ä—É—Ç–æ–π –Ω–∏–∫..."
            maxlength="15"
          />
          <button id="join-btn" class="btn primary full-width">
            –í–æ–π—Ç–∏ –≤ –∏–≥—Ä—É
          </button>
          <div
            id="loadingIndicator"
            class="loading-indicator"
            style="display: none"
          >
            <div class="spinner"></div>
            <span id="loadingText">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
          </div>
        </div>
        <div id="lobby-status" class="status-badge">–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤...</div>
      </div>

      <div id="game" class="hidden">
        <div id="lobby-view" class="card lobby-card">
          <div class="loader"></div>
          <h3>–í—ã –≤ –∏–≥—Ä–µ!</h3>
          <p>
            –í–µ–¥—É—â–∏–π —Å–∫–æ—Ä–æ –Ω–∞—á–Ω–µ—Ç –∫–≤–∏–∑. –ü–æ–∫–∞ –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ, –∫—Ç–æ –µ—â–µ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è:
          </p>
          <div id="player-list-display" class="player-chips"></div>
          <div class="lobby-tips">
            <h4>üí° –°–æ–≤–µ—Ç—ã –¥–ª—è –∏–≥—Ä–æ–∫–æ–≤:</h4>
            <ul>
              <li>–î–æ–∂–¥–∏—Ç–µ—Å—å, –ø–æ–∫–∞ –≤–µ–¥—É—â–∏–π –∑–∞–≥—Ä—É–∑–∏—Ç –≤–æ–ø—Ä–æ—Å—ã</li>
              <li>–ì–æ—Ç–æ–≤—å—Ç–µ—Å—å –∫ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ–π –≤–∏–∫—Ç–æ—Ä–∏–Ω–µ!</li>
              <li>–í—ã–±–∏—Ä–∞–π—Ç–µ –æ—Ç–≤–µ—Ç—ã –±—ã—Å—Ç—Ä–æ –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ</li>
              <li>–°–ª–µ–¥–∏—Ç–µ –∑–∞ —Ç–∞–π–º–µ—Ä–æ–º - –≤—Ä–µ–º—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ</li>
              <li>–ó–∞ –∫–∞–∂–¥—ã–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è –æ—Ç 20 –¥–æ 100 –æ—á–∫–æ–≤</li>
              <li>–ß–µ–º –±—ã—Å—Ç—Ä–µ–µ –æ—Ç–≤–µ—Ç–∏—Ç–µ - —Ç–µ–º –±–æ–ª—å—à–µ –±–∞–ª–ª–æ–≤</li>
            </ul>
          </div>
        </div>

        <div id="quiz-view" class="hidden">
          <div class="timer-container">
            <div id="timer-bar" class="timer-bar"></div>
          </div>

          <div class="card question-card">
            <div class="question-counter">
              –í–æ–ø—Ä–æ—Å <span id="q-num">1</span> –∏–∑ <span id="q-total">10</span>
            </div>
            <h2 id="question-text">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–æ–ø—Ä–æ—Å–∞...</h2>
          </div>

          <div id="options-list" class="options-grid"></div>
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const loginDiv = document.getElementById("login");
      const gameDiv = document.getElementById("game");
      const lobbyView = document.getElementById("lobby-view");
      const quizView = document.getElementById("quiz-view");
      const playerListDisplay = document.getElementById("player-list-display");
      const optionsList = document.getElementById("options-list");
      const timerBar = document.getElementById("timer-bar");
      let myNick = null;

      let mySelection = null;

      function shuffleArray(array) {
        const arr = [...array]; // —Å–æ–∑–¥–∞—ë–º –∫–æ–ø–∏—é, —á—Ç–æ–±—ã –Ω–µ –º—É—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }

      document.getElementById("join-btn").onclick = () => {
        const nick = document.getElementById("nick-input").value.trim();
        if (nick) {
          myNick = nick; // <-- —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∏–∫
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
          showLoadingIndicator(true, "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...");
          socket.emit("join", nick);
          loginDiv.classList.add("hidden");
          gameDiv.classList.remove("hidden");
        }
      };

      document
        .getElementById("nick-input")
        .addEventListener("keydown", (event) => {
          if (event.key === "Enter") {
            const nick = event.target.value.trim();
            if (nick) {
              myNick = nick;
              socket.emit("join", nick);
              loginDiv.classList.add("hidden");
              gameDiv.classList.remove("hidden");
            }
          }
        });

      socket.on("joinError", (message) => {
        alert("–û—à–∏–±–∫–∞: " + message);
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —ç–∫—Ä–∞–Ω –≤–≤–æ–¥–∞ –Ω–∏–∫–∞
        loginDiv.classList.remove("hidden");
        gameDiv.classList.add("hidden");
        myNick = null;
      });

      socket.on("playerListUpdate", (players) => {
        const status = document.getElementById("lobby-status");
        if (status) status.innerText = `–£–∂–µ –≤ –ª–æ–±–±–∏: ${players.length}`;

        playerListDisplay.innerHTML = players
          .map((name) => {
            const isMe = name === myNick;
            return `<span class="chip ${
              isMe ? "chip--me" : ""
            }">${name}</span>`;
          })
          .join("");
      });

      // –ù–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å
      socket.on("updateQuestion", (data) => {
        lobbyView.classList.add("hidden");
        quizView.classList.remove("hidden");
        mySelection = null;

        // 1. –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞
        document.getElementById("question-text").innerHTML = `
        ${data.question}
        ${
          data.questionImg
            ? `<img src="${data.questionImg}" class="question-inline-img">`
            : ""
        }
    `;

        optionsList.innerHTML = "";

        // 2. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
        const indexedOptions = data.options.map((opt, originalIndex) => ({
          ...opt,
          originalIndex,
        }));
        const shuffledOptions = shuffleArray(indexedOptions);

        optionsList.innerHTML = "";
        shuffledOptions.forEach((opt, displayIndex) => {
          const b = document.createElement("button");
          b.className = "btn option-btn" + (opt.img ? " with-img" : "");
          b.dataset.originalIndex = opt.originalIndex; // <-- –¥–æ–±–∞–≤—å—Ç–µ —ç—Ç—É —Å—Ç—Ä–æ–∫—É
          b.innerHTML = `
    ${opt.img ? `<img src="${opt.img}" class="option-img">` : ""}
    <span class="option-label">${opt.text}</span>
  `;

          b.onclick = () => {
            if (mySelection === null) {
              mySelection = opt.originalIndex; // <-- –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å!
              socket.emit("submitAnswer", opt.originalIndex);
              b.classList.add("selected");
              Array.from(optionsList.children).forEach(
                (btn) => (btn.disabled = true),
              );
            }
          };
          optionsList.appendChild(b);
        });

        // –†–µ—Å—Ç–∞—Ä—Ç –∞–Ω–∏–º–∞—Ü–∏–∏ —Ç–∞–π–º–µ—Ä–∞
        timerBar.style.transition = "none";
        timerBar.style.width = "100%";
        setTimeout(() => {
          timerBar.style.transition = `width ${data.timeLeft}s linear`;
          timerBar.style.width = "0%";
        }, 50);
        document.getElementById("q-num").textContent = data.questionNumber;
        document.getElementById("q-total").textContent = data.totalQuestions;
      });

      // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
      socket.on("timeOver", (data) => {
        const { scores, correctAnswer, currentOptions } = data;
        const buttons = optionsList.querySelectorAll("button");

        // 1. –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞
        buttons.forEach((btn) => {
          btn.disabled = true;
          const origIdx = parseInt(btn.dataset.originalIndex, 10);

          if (origIdx === correctAnswer) {
            btn.classList.add("correct");
            btn.innerHTML += " ‚úÖ";
          } else if (origIdx === mySelection && origIdx !== correctAnswer) {
            btn.classList.add("wrong");
            btn.innerHTML += " ‚ùå";
          }
        });

        // 2. –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –∏–∑ currentOptions (–µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω)
        //    –∏–ª–∏ –∏–∑ –∫–Ω–æ–ø–∫–∏ —Å –Ω—É–∂–Ω—ã–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º –∏–Ω–¥–µ–∫—Å–æ–º
        let correctText = "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";

        if (currentOptions && currentOptions[correctAnswer]) {
          correctText = currentOptions[correctAnswer].text;
        } else {
          // –†–µ–∑–µ—Ä–≤–Ω—ã–π —Å–ø–æ—Å–æ–±: –Ω–∞–π—Ç–∏ –∫–Ω–æ–ø–∫—É —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º –∏–Ω–¥–µ–∫—Å–æ–º
          const correctBtn = Array.from(buttons).find(
            (btn) => parseInt(btn.dataset.originalIndex, 10) === correctAnswer,
          );
          if (correctBtn) {
            // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç, —É–±–∏—Ä–∞—è –≤–æ–∑–º–æ–∂–Ω—ã–µ —ç–º–æ–¥–∑–∏ (‚úÖ/‚ùå)
            correctText = correctBtn.textContent.replace(/[‚úÖ‚ùå]/g, "").trim();
          }
        }

        // 3. –ß–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        setTimeout(() => {
          const isCorrect = mySelection === correctAnswer;

          let html = `
      <div class="result-feedback ${
        isCorrect ? "text-success" : "text-danger"
      }">
        <div class="result-status-icon">${isCorrect ? "üî•" : "‚è≥"}</div>
        <h3>${isCorrect ? "–ü—Ä–∞–≤–∏–ª—å–Ω–æ!" : "–£–ø—Å, –Ω–µ —Å–æ–≤—Å–µ–º..."}</h3>
        <p class="correct-answer-reveal">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: <strong>${correctText}</strong></p>
      </div>
      
        <div class="mini-leaderboard">
        <h4>–¢–µ–∫—É—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥:</h4>
        ${Object.entries(scores)
          .sort((a, b) => b[1] - a[1])
          .map(
            ([name, score], i) => `
              <div class="rank-item ${name === myNick ? "is-me" : ""}">
                <span>${i + 1}. ${name}</span>
                <strong>${score}</strong>
              </div>
            `,
          )
          .join("")}
      </div>
    `;
          optionsList.innerHTML = html;
        }, 2000);
      });

      socket.on("quizFinished", (scores) => {
        const sorted = Object.entries(scores).sort((a, b) => b[1] - a[1]);
        const myNick = document.getElementById("nick-input").value;
        const myPlace = sorted.findIndex((item) => item[0] === myNick) + 1;

        quizView.innerHTML = `
        <div class="card result-card">
            <h2>–ö–≤–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω! üèÜ</h2>
            <div class="my-result" style="margin-bottom: 20px; font-size: 1.2rem;">
                ${
                  myPlace > 0
                    ? `–í–∞—à–µ –º–µ—Å—Ç–æ: <strong>#${myPlace}</strong>`
                    : "–í—ã —É—á–∞—Å—Ç–≤–æ–≤–∞–ª–∏ –≤ –∏–≥—Ä–µ"
                }
            </div>
            <div class="mini-leaderboard">
                ${sorted
                  .map(([name, score], i) => {
                    let pClass = "";
                    if (i === 0) pClass = "place-1";
                    else if (i === 1) pClass = "place-2";
                    else if (i === 2) pClass = "place-3";

                    return `
                        <div class="rank-item ${pClass}">
                            <span>${i + 1}. ${name}</span>
                            <strong>${score}</strong>
                        </div>
                    `;
                  })
                  .join("")} 
            </div>
            <p class="footer-msg" style="margin-top: 20px;">–û–∂–∏–¥–∞–π—Ç–µ –Ω–æ–≤–æ–≥–æ –∫–≤–∏–∑–∞!</p>
        </div>
    `;
      });

      // –ï—Å–ª–∏ –≤–µ–¥—É—â–∏–π —Å–±—Ä–æ—Å–∏–ª –∏–≥—Ä—É
      socket.on("gameReset", () => {
        location.reload();
      });

      // –¢—ë–º–Ω–∞—è —Ç–µ–º–∞
      const themeToggle = document.getElementById("themeToggle");
      const html = document.documentElement;

      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é —Ç–µ–º—É
      const savedTheme = localStorage.getItem("theme") || "light";
      html.setAttribute("data-theme", savedTheme);
      updateThemeIcon(savedTheme);

      themeToggle.addEventListener("click", () => {
        const currentTheme = html.getAttribute("data-theme");
        const newTheme = currentTheme === "dark" ? "light" : "dark";
        html.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
        updateThemeIcon(newTheme);
      });

      function updateThemeIcon(theme) {
        themeToggle.innerHTML = theme === "dark" ? "‚òÄÔ∏è" : "üåô";
      }

      function showLoadingIndicator(show, text) {
        const indicator = document.getElementById("loadingIndicator");
        const loadingText = document.getElementById("loadingText");

        if (show) {
          indicator.style.display = "flex";
          loadingText.textContent = text;
        } else {
          indicator.style.display = "none";
        }
      }
    </script>
  </body>
</html>
