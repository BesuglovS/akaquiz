<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>–ê–∫–∞–ö–≤–∏–∑</title>
    <link rel="stylesheet" href="style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap"
      rel="stylesheet"
    />
  </head>
  <body class="player-body">
    <div class="player-container">
      <div id="login" class="card auth-card">
        <h1>–ê–∫–∞–ö–≤–∏–∑</h1>
        <p>–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π –Ω–∏–∫–Ω–µ–π–º, —á—Ç–æ–±—ã –≤–æ–π—Ç–∏ –≤ –∏–≥—Ä—É</p>
        <div class="input-group">
          <input
            type="text"
            id="nick-input"
            placeholder="–í–∞—à –∫—Ä—É—Ç–æ–π –Ω–∏–∫..."
            maxlength="15"
          />
          <button id="join-btn" class="btn primary full-width">
            –í–æ–π—Ç–∏ –≤ –∏–≥—Ä—É
          </button>
        </div>
        <div id="lobby-status" class="status-badge">–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤...</div>
      </div>

      <div id="game" class="hidden">
        <div id="lobby-view" class="card lobby-card">
          <div class="loader"></div>
          <h3>–í—ã –≤ –∏–≥—Ä–µ!</h3>
          <p>
            –í–µ–¥—É—â–∏–π —Å–∫–æ—Ä–æ –Ω–∞—á–Ω–µ—Ç –∫–≤–∏–∑. –ü–æ–∫–∞ –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ, –∫—Ç–æ –µ—â–µ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è:
          </p>
          <div id="player-list-display" class="player-chips"></div>
        </div>

        <div id="quiz-view" class="hidden">
          <div class="timer-container">
            <div id="timer-bar" class="timer-bar"></div>
          </div>

          <div class="card question-card">
            <h2 id="question-text">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–æ–ø—Ä–æ—Å–∞...</h2>
          </div>

          <div id="options-list" class="options-grid"></div>
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const loginDiv = document.getElementById("login");
      const gameDiv = document.getElementById("game");
      const lobbyView = document.getElementById("lobby-view");
      const quizView = document.getElementById("quiz-view");
      const playerListDisplay = document.getElementById("player-list-display");
      const optionsList = document.getElementById("options-list");
      const timerBar = document.getElementById("timer-bar");

      let mySelection = null;

      // –í—Ö–æ–¥ –≤ –∏–≥—Ä—É
      document.getElementById("join-btn").onclick = () => {
        const nick = document.getElementById("nick-input").value.trim();
        if (nick) {
          socket.emit("join", nick);
          loginDiv.classList.add("hidden");
          gameDiv.classList.remove("hidden");
        }
      };

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
      socket.on("playerListUpdate", (players) => {
        const status = document.getElementById("lobby-status");
        if (status) status.innerText = `–£–∂–µ –≤ –ª–æ–±–±–∏: ${players.length}`;

        playerListDisplay.innerHTML = players
          .map((name) => `<span class="chip">${name}</span>`)
          .join("");
      });

      // –ù–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å
      socket.on("updateQuestion", (data) => {
        lobbyView.classList.add("hidden");
        quizView.classList.remove("hidden");
        mySelection = null;

        // 1. –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞
        document.getElementById("question-text").innerHTML = `
        ${data.question}
        ${
          data.questionImg
            ? `<img src="${data.questionImg}" class="question-inline-img">`
            : ""
        }
    `;

        optionsList.innerHTML = "";

        // 2. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
        data.options.forEach((opt, i) => {
          const b = document.createElement("button");
          // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å with-img –µ—Å–ª–∏ –µ—Å—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∞ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∏–ª–µ–π
          b.className = "btn option-btn" + (opt.img ? " with-img" : "");

          // –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º opt.text –∏ opt.img
          b.innerHTML = `
            ${opt.img ? `<img src="${opt.img}" class="option-img">` : ""}
            <span class="option-label">${opt.text}</span>
        `;

          b.onclick = () => {
            if (mySelection === null) {
              mySelection = i;
              socket.emit("submitAnswer", i);
              b.classList.add("selected");
              Array.from(optionsList.children).forEach(
                (btn) => (btn.disabled = true)
              );
            }
          };
          optionsList.appendChild(b);
        });

        // –†–µ—Å—Ç–∞—Ä—Ç –∞–Ω–∏–º–∞—Ü–∏–∏ —Ç–∞–π–º–µ—Ä–∞
        timerBar.style.transition = "none";
        timerBar.style.width = "100%";
        setTimeout(() => {
          timerBar.style.transition = `width ${data.timeLeft}s linear`;
          timerBar.style.width = "0%";
        }, 50);
      });

      // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
      socket.on("timeOver", (data) => {
        const { scores, correctAnswer } = data;
        const buttons = optionsList.querySelectorAll("button");
        const currentQuestionData = data.currentOptions; // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏—Å—ã–ª–∞–µ—Ç —Ç–µ–∫—Å—Ç—ã –æ–ø—Ü–∏–π

        // 1. –°—Ä–∞–∑—É –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
        buttons.forEach((btn, i) => {
          btn.disabled = true;
          if (i === correctAnswer) {
            btn.classList.add("correct"); // –ó–µ–ª–µ–Ω—ã–π –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ
            // –î–æ–±–∞–≤–∏–º –∏–∫–æ–Ω–∫—É –≥–∞–ª–æ—á–∫–∏ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏
            btn.innerHTML += " ‚úÖ";
          } else if (i === mySelection && i !== correctAnswer) {
            btn.classList.add("wrong"); // –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è –æ—à–∏–±–∫–∏ –∏–≥—Ä–æ–∫–∞
            btn.innerHTML += " ‚ùå";
          }
        });

        // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—Å—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –µ–≥–æ —Ç–µ–∫—Å—Ç–æ–º
        // (–ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –∫–Ω–æ–ø–∫–∏ –µ—â–µ —Å–æ–¥–µ—Ä–∂–∞—Ç —Ç–µ–∫—Å—Ç –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤)
        const correctText = buttons[correctAnswer]
          ? buttons[correctAnswer].innerText.replace(" ‚úÖ", "")
          : "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";

        // 2. –ß–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—É–Ω–¥–∞ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
        setTimeout(() => {
          const isCorrect = mySelection === correctAnswer;

          let html = `
            <div class="result-feedback ${
              isCorrect ? "text-success" : "text-danger"
            }">
                <div class="result-status-icon">${isCorrect ? "üî•" : "‚è≥"}</div>
                <h3>${isCorrect ? "–ü—Ä–∞–≤–∏–ª—å–Ω–æ!" : "–£–ø—Å, –Ω–µ —Å–æ–≤—Å–µ–º..."}</h3>
                <p class="correct-answer-reveal">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: <strong>${correctText}</strong></p>
            </div>
            
            <div class="mini-leaderboard">
                <h4>–¢–µ–∫—É—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥:</h4>
                ${Object.entries(scores)
                  .sort((a, b) => b[1] - a[1])
                  .slice(0, 5) // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ø-5
                  .map(
                    ([name, score], i) => `
                        <div class="rank-item ${
                          name === document.getElementById("nick-input").value
                            ? "is-me"
                            : ""
                        }">
                            <span>${i + 1}. ${name}</span>
                            <strong>${score}</strong>
                        </div>
                    `
                  )
                  .join("")}
            </div>
        `;
          optionsList.innerHTML = html;
        }, 2000);
      });

      socket.on("quizFinished", (scores) => {
        const sorted = Object.entries(scores).sort((a, b) => b[1] - a[1]);
        const myNick = document.getElementById("nick-input").value;
        const myPlace = sorted.findIndex((item) => item[0] === myNick) + 1;

        quizView.innerHTML = `
        <div class="card result-card">
            <h2>–ö–≤–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω! üèÜ</h2>
            <div class="my-result" style="margin-bottom: 20px; font-size: 1.2rem;">
                ${
                  myPlace > 0
                    ? `–í–∞—à–µ –º–µ—Å—Ç–æ: <strong>#${myPlace}</strong>`
                    : "–í—ã —É—á–∞—Å—Ç–≤–æ–≤–∞–ª–∏ –≤ –∏–≥—Ä–µ"
                }
            </div>
            <div class="mini-leaderboard">
                ${sorted
                  .map(([name, score], i) => {
                    let pClass = "";
                    if (i === 0) pClass = "place-1";
                    else if (i === 1) pClass = "place-2";
                    else if (i === 2) pClass = "place-3";

                    return `
                        <div class="rank-item ${pClass}">
                            <span>${i + 1}. ${name}</span>
                            <strong>${score}</strong>
                        </div>
                    `;
                  })
                  .join("")} 
            </div>
            <p class="footer-msg" style="margin-top: 20px;">–û–∂–∏–¥–∞–π—Ç–µ –Ω–æ–≤–æ–≥–æ –∫–≤–∏–∑–∞!</p>
        </div>
    `;
      });

      // –ï—Å–ª–∏ –≤–µ–¥—É—â–∏–π —Å–±—Ä–æ—Å–∏–ª –∏–≥—Ä—É
      socket.on("gameReset", () => {
        location.reload();
      });
    </script>
  </body>
</html>
