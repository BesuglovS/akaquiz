<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ê–∫–∞–ö–≤–∏–∑ ‚Äî –í—Ö–æ–¥ –¥–ª—è –≤–µ–¥—É—â–µ–≥–æ</title>
    <link rel="stylesheet" href="style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap"
      rel="stylesheet"
    />
    <style>
      .theme-toggle {
        position: fixed;
        top: 15px;
        right: 15px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        cursor: pointer;
        font-size: 1.3rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
        z-index: 1000;
      }
      .theme-toggle:hover {
        background: rgba(255, 255, 255, 0.4);
        transform: scale(1.1);
      }
      .auth-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        padding: 20px;
        background: #f8f9fa;
      }
      .auth-card {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 400px;
      }
      .auth-card h2 {
        text-align: center;
        margin-bottom: 20px;
      }
      input[type="password"] {
        width: 100%;
        padding: 12px;
        margin: 10px 0;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
      }
      .btn-auth {
        width: 100%;
        padding: 12px;
        background: #6c5ce7;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .btn-auth:hover {
        background: #5a4bd9;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(108, 92, 231, 0.3);
      }
      .btn-auth:active {
        transform: translateY(0);
      }
      .error-msg {
        color: #e74c3c;
        text-align: center;
        margin-top: 10px;
        font-size: 14px;
        animation: shake 0.5s ease-in-out;
      }
      .hidden {
        display: none;
      }

      /* –ê–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ */
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-5px);
        }
        75% {
          transform: translateX(5px);
        }
      }

      @keyframes slideIn {
        from {
          transform: translateX(-100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes bounce {
        0%,
        20%,
        50%,
        80%,
        100% {
          transform: translateY(0);
        }
        40% {
          transform: translateY(-10px);
        }
        60% {
          transform: translateY(-5px);
        }
      }

      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #6c5ce7;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      .loading-text {
        display: inline-block;
        margin-left: 10px;
        animation: pulse 1.5s infinite;
      }

      .fade-in {
        animation: fadeIn 0.5s ease-out;
      }

      .slide-in {
        animation: slideIn 0.3s ease-out;
      }

      .bounce-animation {
        animation: bounce 1s infinite;
      }

      .pulse-animation {
        animation: pulse 1s infinite;
      }

      /* –ü–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –¥–ª—è –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
      .card,
      .btn,
      .custom-select,
      input,
      select {
        transition: all 0.3s ease;
      }

      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .custom-select:hover,
      input:hover {
        border-color: #6c5ce7;
        box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.1);
      }
    </style>
  </head>
  <body class="host-body">
    <button class="theme-toggle" id="themeToggle" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
      üåô
    </button>
    <div id="auth-screen" class="auth-container">
      <div class="auth-card">
        <h2>üîê –í—Ö–æ–¥ –¥–ª—è –≤–µ–¥—É—â–µ–≥–æ</h2>
        <input
          type="password"
          id="host-password"
          placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
        />
        <button class="btn-auth" id="submit-password">–í–æ–π—Ç–∏</button>
        <div id="auth-error" class="error-msg hidden"></div>
      </div>
    </div>

    <!-- –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° (—Å–∫—Ä—ã—Ç –¥–æ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏) -->
    <div id="main-interface" class="host-wrapper hidden">
      <div class="host-wrapper">
        <header id="setup-area" class="card">
          <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–≤–∏–∑–∞</h2>
          <div class="setup-controls">
            <select id="quiz-select" class="custom-select"></select>
            <label class="checkbox-label">
              <input type="checkbox" id="shuffle-questions" />
              –ü–µ—Ä–µ–º–µ—à–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã
            </label>
            <label class="checkbox-label">
              –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤
              <input
                type="number"
                id="question-count"
                min="1"
                placeholder="–í—Å–µ"
                style="width: 80px; margin-left: 10px"
              />
            </label>
            <button id="load-btn" class="btn secondary">
              –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã
            </button>
          </div>
        </header>

        <section id="lobby" class="card">
          <div class="card-header">
            <h3>üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏ –≤ –ª–æ–±–±–∏</h3>
            <span id="player-count-badge" class="badge">0</span>
          </div>
          <div id="player-names" class="player-grid">
            <p class="empty-msg">–û–∂–∏–¥–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞...</p>
          </div>
          <button id="start-game-btn" class="btn primary" disabled>
            –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∫–≤–∏–∑
          </button>
        </section>

        <main id="game-area" class="card main-game hidden">
          <button
            id="reset-btn"
            class="btn secondary hidden"
            style="margin-top: 20px; background: #fab1a0"
          >
            –í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –∫–≤–∏–∑
          </button>

          <div class="game-header">
            <div class="question-counter">
              –í–æ–ø—Ä–æ—Å <span id="q-num">1</span> –∏–∑ <span id="q-total">10</span>
            </div>
            <div id="timer-display" class="timer-circle">--</div>
            <div class="game-info">
              <h1 id="question-area">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–æ–ø—Ä–æ—Å–∞...</h1>
            </div>
          </div>

          <div id="stats-container" class="stats-visualizer"></div>

          <div class="controls">
            <button id="next-btn" class="btn primary">
              –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å ‚Üí
            </button>
          </div>
        </main>

        <aside id="leaderboard-area" class="card hidden">
          <h3>üèÜ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</h3>
          <ul id="leaderboard-list"></ul>
        </aside>

        <aside id="analytics-area" class="card hidden">
          <h3>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤</h3>
          <div class="analytics-controls">
            <button id="show-overall-analytics" class="btn secondary">
              –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º
            </button>
            <button id="show-question-analytics" class="btn secondary">
              –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–µ–∫—É—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É
            </button>
            <button id="export-csv-btn" class="btn primary">
              üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
            </button>
          </div>
          <div id="analytics-content" class="analytics-content"></div>
        </aside>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();

      const authScreen = document.getElementById("auth-screen");
      const mainInterface = document.getElementById("main-interface");
      const passwordInput = document.getElementById("host-password");
      const submitBtn = document.getElementById("submit-password");
      const errorMsg = document.getElementById("auth-error");

      submitBtn.onclick = () => {
        const pwd = passwordInput.value.trim();
        if (!pwd) {
          showError("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å");
          return;
        }
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        showLoadingIndicator(submitBtn, "–ü—Ä–æ–≤–µ—Ä–∫–∞...");
        socket.emit("authenticateHost", pwd);
      };

      passwordInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") submitBtn.click();
      });

      function showError(msg) {
        errorMsg.textContent = msg;
        errorMsg.classList.remove("hidden");
      }

      function showLoadingIndicator(button, text) {
        button.innerHTML = `
          <span class="loading-spinner"></span>
          <span class="loading-text">${text}</span>
        `;
        button.disabled = true;
      }

      socket.on("hostAuthResult", (result) => {
        if (result.success) {
          authScreen.classList.add("hidden");
          mainInterface.classList.remove("hidden");
          // –ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ ‚Äî –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–≤–∏–∑–æ–≤
          socket.emit("getQuizList");
        } else {
          if (result.reason === "already_host") {
            showError("–í–µ–¥—É—â–∏–π —É–∂–µ –ø–æ–¥–∫–ª—é—á—ë–Ω!");
          } else {
            showError("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
            passwordInput.value = "";
            passwordInput.focus();
          }
        }
      });

      // –≠–ª–µ–º–µ–Ω—Ç—ã
      const setupArea = document.getElementById("setup-area");
      const lobby = document.getElementById("lobby");
      const gameArea = document.getElementById("game-area");
      const leaderboardArea = document.getElementById("leaderboard-area");

      const quizSelect = document.getElementById("quiz-select");
      const loadBtn = document.getElementById("load-btn");
      const nextBtn = document.getElementById("next-btn");
      const qArea = document.getElementById("question-area");
      const timerDisp = document.getElementById("timer-display");
      const statsCont = document.getElementById("stats-container");
      const playerNamesDiv = document.getElementById("player-names");
      const playerCountSpan = document.getElementById("player-count-badge");

      socket.on("quizList", (files) => {
        quizSelect.innerHTML = files
          .map((f) => `<option value="${f}">${f}</option>`)
          .join("");
      });

      socket.on("playerListUpdate", (players) => {
        playerCountSpan.innerText = players.length;
        if (players.length > 0) {
          playerNamesDiv.innerHTML = players
            .map((name) => `<div class="player-chip">${name}</div>`)
            .join("");
        }
      });

      loadBtn.onclick = () => {
        const fileName = quizSelect.value;
        if (!fileName) return;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        showLoadingIndicator(loadBtn, "–ó–∞–≥—Ä—É–∑–∫–∞...");
        loadBtn.classList.add("pulse-animation");

        const shouldShuffle =
          document.getElementById("shuffle-questions").checked;

        const countInput = document.getElementById("question-count");
        let questionCount = null;
        if (countInput.value.trim() !== "") {
          const num = parseInt(countInput.value.trim(), 10);
          if (num > 0) questionCount = num;
        }

        socket.emit("selectQuiz", {
          fileName,
          shuffle: shouldShuffle,
          questionCount,
        });
      };

      socket.on("quizReady", (fileName) => {
        // –ö–æ–≥–¥–∞ —Å–µ—Ä–≤–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–∞
        loadBtn.innerText = "‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: " + fileName;
        loadBtn.classList.add("success");

        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Å—Ç–∞—Ä—Ç–∞ –∏ –º–µ–Ω—è–µ–º –µ—ë —Ç–µ–∫—Å—Ç
        const startBtn = document.getElementById("start-game-btn");
        startBtn.disabled = false;
        startBtn.innerText = "–ù–∞—á–∞—Ç—å –∫–≤–∏–∑: " + fileName;

        // –ú–æ–∂–Ω–æ –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å –∫–Ω–æ–ø–∫—É —Å—Ç–∞—Ä—Ç–∞, —á—Ç–æ–±—ã –æ–Ω–∞ –ø—Ä–∏–≤–ª–µ–∫–∞–ª–∞ –≤–Ω–∏–º–∞–Ω–∏–µ
        startBtn.style.animation = "pulse 1.5s infinite";
      });

      // –°—Ç–∞—Ä—Ç –∏–≥—Ä—ã (–ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å)
      document.getElementById("start-game-btn").onclick = () =>
        socket.emit("nextQuestion");
      nextBtn.onclick = () => socket.emit("nextQuestion");

      function formatContent(dataObj) {
        let html = `<span>${dataObj.text || ""}</span>`;
        if (dataObj.img) {
          html += `<img src="${dataObj.img}" class="content-img">`;
        }
        return html;
      }

      socket.on("updateQuestion", (data) => {
        setupArea.classList.add("hidden");
        lobby.classList.add("hidden");
        gameArea.classList.remove("hidden");

        // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—è–≤–ª–µ–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞
        qArea.innerHTML = `
          <div class="question-title fade-in">${data.question}</div>
          ${
            data.questionImg
              ? `<img src="${data.questionImg}" class="main-question-img slide-in">`
              : ""
          }
      `;

        // –ü–µ—Ä–µ–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –æ–ø—Ü–∏–π –≤ —Ä–µ–Ω–¥–µ—Ä –≥—Ä–∞—Ñ–∏–∫–æ–≤
        renderStats(data.options);

        nextBtn.innerText = "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º—è"; // –¢–µ–∫—Å—Ç –≤–æ –≤—Ä–µ–º—è –≤–æ–ø—Ä–æ—Å–∞
        nextBtn.classList.remove("secondary");
        nextBtn.classList.add("primary");

        document.getElementById("q-num").textContent = data.questionNumber;
        document.getElementById("q-total").textContent = data.totalQuestions;
      });

      socket.on("timerTick", (time) => {
        timerDisp.innerText = time;
        timerDisp.style.borderColor = time <= 5 ? "#e74c3c" : "#6c5ce7";
      });

      socket.on("updateStats", (votes) => {
        const bars = document.querySelectorAll(".bar-fill");
        bars.forEach((bar, index) => {
          const count = votes[index] || 0;
          const targetHeight = `${Math.min(count * 20, 100)}%`;

          // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —Ä–æ—Å—Ç–∞ —Å—Ç–æ–ª–±—Ü–æ–≤
          bar.style.transition = "height 0.5s ease-out";
          bar.style.height = targetHeight;
          bar.setAttribute("data-count", count);

          // –î–æ–±–∞–≤–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç "–ø—Ä—ã–∂–∫–∞" –¥–ª—è –Ω–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
          if (count > 0) {
            bar.style.animation = "bounce 0.5s ease-out";
            setTimeout(() => {
              bar.style.animation = "";
            }, 500);
          }
        });
      });

      function renderStats(options) {
        statsCont.innerHTML = options
          .map(
            (opt, i) => `
          <div class="stat-column">
              <div class="bar-wrapper">
                  <div class="bar-fill" style="height: 0%" data-count="0"></div>
              </div>
              <div class="bar-label">
                  ${
                    opt.img
                      ? `<img src="${opt.img}" style="width:30px; height:30px; object-fit:cover; border-radius:4px; display:block; margin:0 auto 5px;">`
                      : ""
                  }
                  ${opt.text}
              </div>
          </div>
      `,
          )
          .join("");
      }

      socket.on("timeOver", (data) => {
        nextBtn.innerText = "–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å ‚Üí"; // –ö–æ–≥–¥–∞ –≤—Ä–µ–º—è –≤—ã—à–ª–æ
        leaderboardArea.classList.remove("hidden");
        updateLeaderboard(data.scores);

        nextBtn.innerText = "–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å ‚Üí"; // –¢–µ–∫—Å—Ç –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        nextBtn.classList.remove("primary");
        nextBtn.classList.add("secondary");

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø–æ –≤–æ–ø—Ä–æ—Å—É –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        analyticsArea.classList.remove("hidden");
        showQuestionAnalytics();
      });

      socket.on("quizFinished", (scores) => {
        qArea.innerHTML = "üèÅ –ö–≤–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!";
        nextBtn.style.display = "none";
        updateLeaderboard(scores);
      });

      function updateLeaderboard(scores) {
        // –ü–æ–ª—É—á–∞–µ–º –º–∞—Å—Å–∏–≤ –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º. 0 —Ç–µ–ø–µ—Ä—å –±—É–¥–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–µ
        const sorted = Object.entries(scores).sort((a, b) => b[1] - a[1]);
        const list = document.getElementById("leaderboard-list");

        // –£–±–∏—Ä–∞–µ–º —É—Å–ª–æ–≤–∏–µ "if (sorted.length === 0)" –∏–ª–∏ –¥–µ–ª–∞–µ–º –µ–≥–æ —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ª—É—á–∞—è,
        // –∫–æ–≥–¥–∞ –≤ –∏–≥—Ä–µ –≤–æ–æ–±—â–µ –Ω–µ—Ç –ª—é–¥–µ–π
        if (Object.keys(scores).length === 0) {
          list.innerHTML = "<li>–ñ–¥–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤...</li>";
          return;
        }

        list.innerHTML = sorted
          .map(([name, val], i) => {
            let placeClass = "";
            if (i === 0 && val > 0) placeClass = "place-1 winner-anim";
            // –ê–Ω–∏–º–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –æ—á–∫–∏
            else if (i === 1 && val > 0) placeClass = "place-2";
            else if (i === 2 && val > 0) placeClass = "place-3";

            return `
              <li class="rank-item ${placeClass}">
                  <span class="rank-icon"></span>
                  <span class="rank">${i + 1}</span>
                  <span class="name">${name}</span>
                  <span class="score">${val}</span>
              </li>`;
          })
          .join("");
      }

      const resetBtn = document.getElementById("reset-btn");

      // –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ "–°–ª–µ–¥—É—é—â–∏–π" —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å—Å—è
      nextBtn.onclick = () => socket.emit("nextQuestion");

      // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
      socket.on("quizFinished", (scores) => {
        qArea.innerHTML = "üèÅ –ö–≤–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω! –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π!";
        nextBtn.classList.add("hidden");
        resetBtn.classList.remove("hidden");
        updateLeaderboard(scores); // –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥
      });

      resetBtn.onclick = () => {
        socket.emit("resetGame");
        location.reload(); // –ü—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± –≤–µ—Ä–Ω—É—Ç—å —Ö–æ—Å—Ç–∞ –≤ –Ω–∞—á–∞–ª–æ
      };

      // --- –ê–ù–ê–õ–ò–¢–ò–ö–ê –û–¢–í–ï–¢–û–í ---
      const analyticsArea = document.getElementById("analytics-area");
      const analyticsContent = document.getElementById("analytics-content");
      const showOverallBtn = document.getElementById("show-overall-analytics");
      const showQuestionBtn = document.getElementById(
        "show-question-analytics",
      );
      const exportCsvBtn = document.getElementById("export-csv-btn");

      // –ü–æ–∫–∞–∑–∞—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–≥—Ä—ã
      socket.on("quizFinished", () => {
        analyticsArea.classList.remove("hidden");
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        showOverallAnalytics();
      });

      // –ü–æ–∫–∞–∑–∞—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º –≤–æ –≤—Ä–µ–º—è –∏–≥—Ä—ã
      socket.on("updateStats", () => {
        // –ï—Å–ª–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–∞, –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º
        if (!analyticsArea.classList.contains("hidden")) {
          showQuestionAnalytics();
        }
      });

      // –û–±—â–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
      showOverallBtn.onclick = () => {
        showOverallAnalytics();
        showOverallBtn.classList.add("active");
        showQuestionBtn.classList.remove("active");
      };

      // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º
      showQuestionBtn.onclick = () => {
        showQuestionAnalytics();
        showQuestionBtn.classList.add("active");
        showOverallBtn.classList.remove("active");
      };

      // –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
      exportCsvBtn.onclick = () => {
        exportCsvBtn.disabled = true;
        exportCsvBtn.innerText = "–≠–∫—Å–ø–æ—Ä—Ç...";
        socket.emit("exportResults");
      };

      function showOverallAnalytics() {
        socket.emit("getAnalytics");
      }

      function showQuestionAnalytics() {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø–æ —Ç–µ–∫—É—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É (–µ—Å–ª–∏ –µ—Å—Ç—å)
        // –î–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –≤–æ–ø—Ä–æ—Å—É
        socket.emit("getQuestionAnalytics", -1);
      }

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
      socket.on("analyticsData", (data) => {
        const accuracy =
          data.totalAnswers > 0
            ? ((data.correctAnswers / data.totalAnswers) * 100).toFixed(1)
            : 0;

        analyticsContent.innerHTML = `
            <div class="analytics-grid">
              <div class="analytics-card">
                <h4>üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
                <div class="metric">
                  <span class="metric-label">–í—Å–µ–≥–æ –æ—Ç–≤–µ—Ç–æ–≤:</span>
                  <span class="metric-value">${data.totalAnswers}</span>
                </div>
                <div class="metric">
                  <span class="metric-label">–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤:</span>
                  <span class="metric-value correct">${data.correctAnswers}</span>
                </div>
                <div class="metric">
                  <span class="metric-label">–ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö:</span>
                  <span class="metric-value">${accuracy}%</span>
                </div>
                <div class="metric">
                  <span class="metric-label">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞:</span>
                  <span class="metric-value">${data.averageResponseTime.toFixed(2)} —Å</span>
                </div>
              </div>
              <div class="analytics-card">
                <h4>‚è±Ô∏è –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏</h4>
                ${renderTimeDistribution(data.responseTimeDistribution)}
              </div>
            </div>
          `;
      });

      socket.on("questionAnalyticsData", (data) => {
        const accuracy =
          data.totalAnswers > 0
            ? ((data.correctAnswers / data.totalAnswers) * 100).toFixed(1)
            : 0;

        analyticsContent.innerHTML = `
            <div class="analytics-card">
              <div class="metric">
                <span class="metric-label">–û—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –≤–æ–ø—Ä–æ—Å:</span>
                <span class="metric-value">${data.totalAnswers}</span>
              </div>
              <div class="metric">
                <span class="metric-label">–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤:</span>
                <span class="metric-value correct">${data.correctAnswers}</span>
              </div>
              <div class="metric">
                <span class="metric-label">–ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö:</span>
                <span class="metric-value">${accuracy}%</span>
              </div>
              <div class="metric">
                <span class="metric-label">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞:</span>
                <span class="metric-value">${data.averageResponseTime.toFixed(2)} —Å</span>
              </div>
              <div class="metric">
                <span class="metric-label">–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–æ–≤:</span>
                <span class="metric-value">${data.responseTimes.map((t) => t.toFixed(2)).join(", ")} —Å</span>
              </div>
            </div>
          `;
      });

      socket.on("csvExportReady", (csvContent) => {
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        exportCsvBtn.disabled = false;
        exportCsvBtn.innerText = "üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV";

        // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const link = document.createElement("a");

        // –°–æ–∑–¥–∞–µ–º URL –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute(
          "download",
          `quiz_results_${new Date().toISOString().slice(0, 19).replace(/:/g, "-")}.csv`,
        );
        link.style.visibility = "hidden";

        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –≤ DOM –∏ –∫–ª–∏–∫–∞–µ–º –ø–æ –Ω–µ–π
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // –û–ø–æ–≤–µ—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–± —É—Å–ø–µ—à–Ω–æ–º —ç–∫—Å–ø–æ—Ä—Ç–µ
        analyticsContent.innerHTML = `
            <div class="analytics-card">
              <h4>‚úÖ –≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω</h4>
              <p>–§–∞–π–ª CSV —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ –≤–∞—à –∫–æ–º–ø—å—é—Ç–µ—Ä.</p>
              <p class="metric-label">–ò–º—è —Ñ–∞–π–ª–∞: quiz_results_${new Date().toISOString().slice(0, 19).replace(/:/g, "-")}.csv</p>
            </div>
          `;
      });

      function renderTimeDistribution(times) {
        if (times.length === 0) {
          return "<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–æ–≤</p>";
        }

        const maxTime = Math.max(...times);
        const bins = 5;
        const binSize = maxTime / bins;
        const distribution = Array(bins).fill(0);

        times.forEach((time) => {
          const binIndex = Math.min(Math.floor(time / binSize), bins - 1);
          distribution[binIndex]++;
        });

        return `
            <div class="time-chart">
              ${distribution
                .map((count, index) => {
                  const start = (index * binSize).toFixed(1);
                  const end = ((index + 1) * binSize).toFixed(1);
                  const percentage = ((count / times.length) * 100).toFixed(0);
                  return `
                  <div class="time-bin">
                    <span class="bin-label">${start}-${end}—Å</span>
                    <div class="bin-bar">
                      <div class="bin-fill" style="width: ${percentage}%"></div>
                    </div>
                    <span class="bin-count">${count} –æ—Ç–≤–µ—Ç–æ–≤ (${percentage}%)</span>
                  </div>
                `;
                })
                .join("")}
            </div>
          `;
      }

      // –¢—ë–º–Ω–∞—è —Ç–µ–º–∞
      const themeToggle = document.getElementById("themeToggle");
      const html = document.documentElement;

      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é —Ç–µ–º—É
      const savedTheme = localStorage.getItem("theme") || "light";
      html.setAttribute("data-theme", savedTheme);
      updateThemeIcon(savedTheme);

      themeToggle.addEventListener("click", () => {
        const currentTheme = html.getAttribute("data-theme");
        const newTheme = currentTheme === "dark" ? "light" : "dark";
        html.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
        updateThemeIcon(newTheme);
      });

      function updateThemeIcon(theme) {
        themeToggle.innerHTML = theme === "dark" ? "‚òÄÔ∏è" : "üåô";
      }
    </script>
  </body>
</html>
