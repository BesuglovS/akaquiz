<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ê–∫–∞–ö–≤–∏–∑ ‚Äî –í—Ö–æ–¥ –¥–ª—è –≤–µ–¥—É—â–µ–≥–æ</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <style>
    .auth-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      padding: 20px;
      background: #f8f9fa;
    }
    .auth-card {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
    }
    .auth-card h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    input[type="password"] {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
    }
    .btn-auth {
      width: 100%;
      padding: 12px;
      background: #6c5ce7;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }
    .btn-auth:hover {
      background: #5a4bd9;
    }
    .error-msg {
      color: #e74c3c;
      text-align: center;
      margin-top: 10px;
      font-size: 14px;
    }
    .hidden { display: none; }
  </style>
</head>
<body class="host-body">
  <div id="auth-screen" class="auth-container">
    <div class="auth-card">
      <h2>üîê –í—Ö–æ–¥ –¥–ª—è –≤–µ–¥—É—â–µ–≥–æ</h2>
      <input type="password" id="host-password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" />
      <button class="btn-auth" id="submit-password">–í–æ–π—Ç–∏</button>
      <div id="auth-error" class="error-msg hidden"></div>
    </div>
  </div>

  <!-- –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° (—Å–∫—Ä—ã—Ç –¥–æ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏) -->
  <div id="main-interface" class="host-wrapper hidden">
    <div class="host-wrapper">
      <header id="setup-area" class="card">
        <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–≤–∏–∑–∞</h2>
        <div class="setup-controls">
          <select id="quiz-select" class="custom-select"></select>
          <label class="checkbox-label">
            <input type="checkbox" id="shuffle-questions" />
            –ü–µ—Ä–µ–º–µ—à–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã
          </label>
          <label class="checkbox-label">
            –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤
            <input
              type="number"
              id="question-count"
              min="1"
              placeholder="–í—Å–µ"
              style="width: 80px; margin-left: 10px"
            />
          </label>
          <button id="load-btn" class="btn secondary">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã</button>
        </div>
      </header>

      <section id="lobby" class="card">
        <div class="card-header">
          <h3>üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏ –≤ –ª–æ–±–±–∏</h3>
          <span id="player-count-badge" class="badge">0</span>
        </div>
        <div id="player-names" class="player-grid">
          <p class="empty-msg">–û–∂–∏–¥–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞...</p>
        </div>
        <button id="start-game-btn" class="btn primary" disabled>
          –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∫–≤–∏–∑
        </button>
      </section>

      <main id="game-area" class="card main-game hidden">
        <button
          id="reset-btn"
          class="btn secondary hidden"
          style="margin-top: 20px; background: #fab1a0"
        >
          –í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –∫–≤–∏–∑
        </button>

        <div class="game-header">
          <div class="question-counter">
            –í–æ–ø—Ä–æ—Å <span id="q-num">1</span> –∏–∑ <span id="q-total">10</span>
          </div>
          <div id="timer-display" class="timer-circle">--</div>
          <div class="game-info">
            <h1 id="question-area">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–æ–ø—Ä–æ—Å–∞...</h1>
          </div>
        </div>

        <div id="stats-container" class="stats-visualizer"></div>

        <div class="controls">
          <button id="next-btn" class="btn primary">–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å ‚Üí</button>
        </div>
      </main>

      <aside id="leaderboard-area" class="card hidden">
        <h3>üèÜ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</h3>
        <ul id="leaderboard-list"></ul>
      </aside>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    const authScreen = document.getElementById("auth-screen");
    const mainInterface = document.getElementById("main-interface");
    const passwordInput = document.getElementById("host-password");
    const submitBtn = document.getElementById("submit-password");
    const errorMsg = document.getElementById("auth-error");

    submitBtn.onclick = () => {
      const pwd = passwordInput.value.trim();
      if (!pwd) {
        showError("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å");
        return;
      }
      socket.emit("authenticateHost", pwd);
    };

    passwordInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") submitBtn.click();
    });

    function showError(msg) {
      errorMsg.textContent = msg;
      errorMsg.classList.remove("hidden");
    }

    socket.on("hostAuthResult", (result) => {
      if (result.success) {
        authScreen.classList.add("hidden");
        mainInterface.classList.remove("hidden");
        // –ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ ‚Äî –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–≤–∏–∑–æ–≤
        socket.emit("getQuizList");
      } else {
        if (result.reason === "already_host") {
          showError("–í–µ–¥—É—â–∏–π —É–∂–µ –ø–æ–¥–∫–ª—é—á—ë–Ω!");
        } else {
          showError("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
          passwordInput.value = "";
          passwordInput.focus();
        }
      }
    });
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã
      const setupArea = document.getElementById("setup-area");
      const lobby = document.getElementById("lobby");
      const gameArea = document.getElementById("game-area");
      const leaderboardArea = document.getElementById("leaderboard-area");

      const quizSelect = document.getElementById("quiz-select");
      const loadBtn = document.getElementById("load-btn");
      const nextBtn = document.getElementById("next-btn");
      const qArea = document.getElementById("question-area");
      const timerDisp = document.getElementById("timer-display");
      const statsCont = document.getElementById("stats-container");
      const playerNamesDiv = document.getElementById("player-names");
      const playerCountSpan = document.getElementById("player-count-badge");

      socket.on("quizList", (files) => {
        quizSelect.innerHTML = files
          .map((f) => `<option value="${f}">${f}</option>`)
          .join("");
      });

      socket.on("playerListUpdate", (players) => {
        playerCountSpan.innerText = players.length;
        if (players.length > 0) {
          playerNamesDiv.innerHTML = players
            .map((name) => `<div class="player-chip">${name}</div>`)
            .join("");
        }
      });

      loadBtn.onclick = () => {
        const fileName = quizSelect.value;
        if (!fileName) return;

        const shouldShuffle =
          document.getElementById("shuffle-questions").checked;

        const countInput = document.getElementById("question-count");
        let questionCount = null;
        if (countInput.value.trim() !== "") {
          const num = parseInt(countInput.value.trim(), 10);
          if (num > 0) questionCount = num;
        }

        socket.emit("selectQuiz", {
          fileName,
          shuffle: shouldShuffle,
          questionCount,
        });
      };

      socket.on("quizReady", (fileName) => {
        // –ö–æ–≥–¥–∞ —Å–µ—Ä–≤–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–∞
        loadBtn.innerText = "‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: " + fileName;
        loadBtn.classList.add("success");

        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Å—Ç–∞—Ä—Ç–∞ –∏ –º–µ–Ω—è–µ–º –µ—ë —Ç–µ–∫—Å—Ç
        const startBtn = document.getElementById("start-game-btn");
        startBtn.disabled = false;
        startBtn.innerText = "–ù–∞—á–∞—Ç—å –∫–≤–∏–∑: " + fileName;

        // –ú–æ–∂–Ω–æ –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å –∫–Ω–æ–ø–∫—É —Å—Ç–∞—Ä—Ç–∞, —á—Ç–æ–±—ã –æ–Ω–∞ –ø—Ä–∏–≤–ª–µ–∫–∞–ª–∞ –≤–Ω–∏–º–∞–Ω–∏–µ
        startBtn.style.animation = "pulse 1.5s infinite";
      });

      // –°—Ç–∞—Ä—Ç –∏–≥—Ä—ã (–ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å)
      document.getElementById("start-game-btn").onclick = () =>
        socket.emit("nextQuestion");
      nextBtn.onclick = () => socket.emit("nextQuestion");

      function formatContent(dataObj) {
        let html = `<span>${dataObj.text || ""}</span>`;
        if (dataObj.img) {
          html += `<img src="${dataObj.img}" class="content-img">`;
        }
        return html;
      }

      socket.on("updateQuestion", (data) => {
        setupArea.classList.add("hidden");
        lobby.classList.add("hidden");
        gameArea.classList.remove("hidden");

        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞ –∏ –∫–∞—Ä—Ç–∏–Ω–∫—É –≤–æ–ø—Ä–æ—Å–∞
        qArea.innerHTML = `
        <div class="question-title">${data.question}</div>
        ${
          data.questionImg
            ? `<img src="${data.questionImg}" class="main-question-img">`
            : ""
        }
    `;

        // –ü–µ—Ä–µ–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –æ–ø—Ü–∏–π –≤ —Ä–µ–Ω–¥–µ—Ä –≥—Ä–∞—Ñ–∏–∫–æ–≤
        renderStats(data.options);

        nextBtn.innerText = "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º—è"; // –¢–µ–∫—Å—Ç –≤–æ –≤—Ä–µ–º—è –≤–æ–ø—Ä–æ—Å–∞
        nextBtn.classList.remove("secondary");
        nextBtn.classList.add("primary");

        document.getElementById("q-num").textContent = data.questionNumber;
        document.getElementById("q-total").textContent = data.totalQuestions;
      });

      socket.on("timerTick", (time) => {
        timerDisp.innerText = time;
        timerDisp.style.borderColor = time <= 5 ? "#e74c3c" : "#6c5ce7";
      });

      socket.on("updateStats", (votes) => {
        const bars = document.querySelectorAll(".bar-fill");
        bars.forEach((bar, index) => {
          const count = votes[index] || 0;
          bar.style.height = `${Math.min(count * 20, 100)}%`;
          bar.setAttribute("data-count", count);
        });
      });

      function renderStats(options) {
        statsCont.innerHTML = options
          .map(
            (opt, i) => `
        <div class="stat-column">
            <div class="bar-wrapper">
                <div class="bar-fill" style="height: 0%" data-count="0"></div>
            </div>
            <div class="bar-label">
                ${
                  opt.img
                    ? `<img src="${opt.img}" style="width:30px; height:30px; object-fit:cover; border-radius:4px; display:block; margin:0 auto 5px;">`
                    : ""
                }
                ${opt.text}
            </div> 
        </div>
    `
          )
          .join("");
      }

      socket.on("timeOver", (data) => {
        nextBtn.innerText = "–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å ‚Üí"; // –ö–æ–≥–¥–∞ –≤—Ä–µ–º—è –≤—ã—à–ª–æ
        leaderboardArea.classList.remove("hidden");
        updateLeaderboard(data.scores);

        nextBtn.innerText = "–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å ‚Üí"; // –¢–µ–∫—Å—Ç –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        nextBtn.classList.remove("primary");
        nextBtn.classList.add("secondary");
      });

      socket.on("quizFinished", (scores) => {
        qArea.innerHTML = "üèÅ –ö–≤–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!";
        nextBtn.style.display = "none";
        updateLeaderboard(scores);
      });

      function updateLeaderboard(scores) {
        // –ü–æ–ª—É—á–∞–µ–º –º–∞—Å—Å–∏–≤ –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º. 0 —Ç–µ–ø–µ—Ä—å –±—É–¥–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–µ
        const sorted = Object.entries(scores).sort((a, b) => b[1] - a[1]);
        const list = document.getElementById("leaderboard-list");

        // –£–±–∏—Ä–∞–µ–º —É—Å–ª–æ–≤–∏–µ "if (sorted.length === 0)" –∏–ª–∏ –¥–µ–ª–∞–µ–º –µ–≥–æ —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ª—É—á–∞—è,
        // –∫–æ–≥–¥–∞ –≤ –∏–≥—Ä–µ –≤–æ–æ–±—â–µ –Ω–µ—Ç –ª—é–¥–µ–π
        if (Object.keys(scores).length === 0) {
          list.innerHTML = "<li>–ñ–¥–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤...</li>";
          return;
        }

        list.innerHTML = sorted
          .map(([name, val], i) => {
            let placeClass = "";
            if (i === 0 && val > 0) placeClass = "place-1 winner-anim";
            // –ê–Ω–∏–º–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –æ—á–∫–∏
            else if (i === 1 && val > 0) placeClass = "place-2";
            else if (i === 2 && val > 0) placeClass = "place-3";

            return `
            <li class="rank-item ${placeClass}">
                <span class="rank-icon"></span>
                <span class="rank">${i + 1}</span>
                <span class="name">${name}</span>
                <span class="score">${val}</span>
            </li>`;
          })
          .join("");
      }

      const resetBtn = document.getElementById("reset-btn");

      // –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ "–°–ª–µ–¥—É—é—â–∏–π" —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å—Å—è
      nextBtn.onclick = () => socket.emit("nextQuestion");

      // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
      socket.on("quizFinished", (scores) => {
        qArea.innerHTML = "üèÅ –ö–≤–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω! –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π!";
        nextBtn.classList.add("hidden");
        resetBtn.classList.remove("hidden");
        updateLeaderboard(scores); // –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥
      });

      resetBtn.onclick = () => {
        socket.emit("resetGame");
        location.reload(); // –ü—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± –≤–µ—Ä–Ω—É—Ç—å —Ö–æ—Å—Ç–∞ –≤ –Ω–∞—á–∞–ª–æ
      };
    
  </script>

  <!-- –í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –≤–∞—à –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π JS-–∫–æ–¥ –∏–∑ host.html (–≤—Å—ë, —á—Ç–æ –±—ã–ª–æ –≤–Ω—É—Ç—Ä–∏ <script> –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è socket.io) -->
  <!-- –ù–æ —É–±–µ—Ä–∏—Ç–µ –∏–∑ –Ω–µ–≥–æ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É socket.emit("getQuizList"); ‚Äî –æ–Ω–∞ —Ç–µ–ø–µ—Ä—å –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
   
</body>
</html>